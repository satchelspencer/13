<!DOCTYPE html>
<html>
<head>
	<title>Chat</title>
	<script type="text/javascript" src="zepto.min.js"></script>
	<script>
		Zepto(function($) {
			var myUsername = $('#username').html();
			console.log($('#username'));
			console.log($('#username').html());

			if (window.WebSocket) {
				connectToWebSocket();
			} else {
				console.log('WebSockets not supported');
			}

			function connectToWebSocket() {
				websocket = new WebSocket('ws://192.168.1.1:81');
				websocket.onopen = function(evt) {
					$('#connection').html('Connected');
					setTimeout(function() {
						$('#connection').hide();
					}, 3000);
					sendCommand('connect', myUsername);
				};
				websocket.onclose = function(evt) {
					$('#connection').html('Disconnected');
					$('#connection').show();
				};
				websocket.onmessage = function(evt) {
					addMessage('RESPONSE', evt.data);
				};
				websocket.onerror = function(evt) {
					addMessage('ERROR', evt.data);
				};
			}

			function escapeHtml(text) {
				var map = {
					'&': '&amp;',
					'<': '&lt;',
					'>': '&gt;',
					'"': '&quot;',
					"'": '&#039;'
				};
				return text.replace(/[&<>"']/g, function(m) { return map[m]; });
			}

			function sendCommand(command, text) {
				message = 'chat:' + command + ':' + escapeHtml(text);
				websocket.send(message);
			}

			function sendMessage(message) {
				addMessage(myUsername, message);
				sendCommand('message', message);
			}

			function addMessage(username, message) {
				messageElement = '<p class="message"><strong class="username';
				if (username == myUsername) {
					messageElement += ' me';
				}
				messageElement += '">' + username + '</strong>: ' + escapeHtml(message) + '</p>';
				$('#messages').append(messageElement);
			}
		});
	</script>
</head>
<body>
	<h1>Chat</h1>
	<span>Logged in as </span><strong id="username">{{username}}</strong>
	<p id="connection">Connecting to server</p>
	<div id="messages"></div>
</body>
</html>
