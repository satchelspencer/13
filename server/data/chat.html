<!DOCTYPE html>
<html>
<head>
	<title>Chat</title>
	<script type="text/javascript" src="zepto.min.js"></script>
	<script type="text/javascript" src="websockets.js"></script>
	<script>
		Zepto(function($) {
			$.ajax({
				type: 'GET',
				url: '/api/whoami',
				success: function(data, status, xhr) {
					if (data.success) {
						$('#username').text(data.username);
					} else {
						alert('Server error');
					}
				},
				error: function(xhr, errorType, error) {
					alert('Server error');
				}
			});

			var socket = websocket('ws://192.168.1.1:81', 'chat');

			socket.error(function(error){
				console.log('websocket error:'+error);
			});

			socket.ready(function(){
				console.log('websocket ready!');
			});

			socket.on('message', function(message){
				var chunks = message.split(';');
				$('#messages').append(chunks[0] + ': ' + decodeURIComponent(chunks[1])+'<br>');
			});

			$('.send').click(function(){
				socket.send('message', $('.chat').val());
			});
		});
	</script>
</head>
<body>
	<h1>Chat</h1>
	<span>Logged in as </span><strong id="username"></strong>
	<input type="text" class="chat"><span class="send">send</span>
	<div id="messages"></div>
</body>
</html>
